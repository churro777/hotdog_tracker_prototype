name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # ============================================================================
  # QUALITY CHECKS - Code quality, tests, and type checking
  # ============================================================================
  quality-checks:
    name: Code Quality & Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Type check
        run: npx tsc --noEmit

      - name: Run tests
        run: npm run test:run

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/coverage-final.json
          fail_ci_if_error: false

      - name: Build application
        run: npm run build

      - name: Check bundle size
        run: npm run build:size

      # Cache build artifacts for other jobs
      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: dist
          key: build-${{ github.sha }}

  # ============================================================================
  # ACCESSIBILITY TESTS - Lighthouse and a11y checks
  # ============================================================================
  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # ============================================================================
  # SECURITY SCANS - Dependency, code, and secret scanning
  # ============================================================================
  security-dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate

      - name: Check for known security issues
        run: npx audit-ci --moderate
        continue-on-error: false

  security-codeql-scan:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  security-secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-vulnerability-scan:
    name: Vulnerability Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # DEPLOYMENT - Deploy to GitHub Pages only after all checks pass
  # ============================================================================
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    # Only run on push to main (not PRs) and only after all other jobs succeed
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs:
      - quality-checks
      - accessibility-tests
      - security-dependency-scan
      - security-codeql-scan
      - security-secret-scan
      - security-vulnerability-scan

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Generate bundle analysis
        run: npm run build:analyze

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment deployment status
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: '${{ steps.deployment.outputs.page_url }}',
              description: 'Deployed to GitHub Pages',
              context: 'deployment'
            })

  # ============================================================================
  # SUMMARY - Post a summary comment on PRs
  # ============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs:
      - quality-checks
      - accessibility-tests
      - security-dependency-scan
      - security-codeql-scan
      - security-secret-scan
      - security-vulnerability-scan

    steps:
      - name: Post pipeline summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'Quality Checks': '${{ needs.quality-checks.result }}',
              'Accessibility Tests': '${{ needs.accessibility-tests.result }}',
              'Dependency Security': '${{ needs.security-dependency-scan.result }}',
              'CodeQL Analysis': '${{ needs.security-codeql-scan.result }}',
              'Secret Scanning': '${{ needs.security-secret-scan.result }}',
              'Vulnerability Scan': '${{ needs.security-vulnerability-scan.result }}'
            };

            let summary = '## üöÄ CI/CD Pipeline Results\n\n';
            for (const [job, result] of Object.entries(results)) {
              const icon = result === 'success' ? '‚úÖ' : result === 'failure' ? '‚ùå' : result === 'cancelled' ? '‚èπÔ∏è' : '‚è≥';
              summary += `${icon} **${job}**: ${result}\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
